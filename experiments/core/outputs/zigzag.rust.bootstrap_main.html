<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSMC Inference Report</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f8ff;
      --ink: #15253a;
      --muted: #58708c;
      --card: rgba(255,255,255,0.78);
      --stroke: rgba(17, 34, 51, 0.12);
      --shadow: 0 20px 70px rgba(27, 45, 72, 0.15);
      --accent: #f4511e;
      --accent2: #26a69a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(900px 480px at -8% -10%, rgba(244,81,30,0.18), transparent 70%),
        radial-gradient(980px 480px at 108% -10%, rgba(38,166,154,0.18), transparent 68%),
        linear-gradient(135deg, #f7f9ff, #edf6ff 52%, #f7fbff);
      font-family: "Sora", "Segoe UI", sans-serif;
      min-height: 100vh;
    }
    .wrap { max-width: 1320px; margin: 0 auto; padding: 26px 18px 36px; }
    .hero h1 {
      margin: 0;
      font-size: clamp(1.45rem, 2.5vw, 2.5rem);
      letter-spacing: -0.02em;
      line-height: 1.08;
      font-weight: 800;
    }
    .hero .sub {
      margin-top: 10px;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .card {
      margin-top: 18px;
      border-radius: 20px;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(255,255,255,0.88), rgba(255,255,255,0.74));
      backdrop-filter: blur(6px);
      overflow: hidden;
    }
    .control-card {
      padding: 12px 14px;
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(245,251,255,0.78));
    }
    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 12px;
      align-items: center;
    }
    .ctrl-block {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.83rem;
      color: #35506a;
      font-weight: 600;
    }
    .ctrl-block select,
    .ctrl-block input[type="range"] {
      width: 100%;
    }
    .ctrl-block select {
      border: 1px solid rgba(17, 34, 51, 0.18);
      border-radius: 8px;
      padding: 6px 8px;
      color: #1f354a;
      background: rgba(255,255,255,0.86);
      font-size: 0.82rem;
    }
    .ctrl-block input[type="checkbox"] {
      accent-color: #f4511e;
    }
    .ctrl-block .val {
      min-width: 32px;
      text-align: right;
      color: #1f354a;
      font-family: "IBM Plex Mono", monospace;
      font-size: 0.78rem;
    }
    .chart-wrap { padding: 12px 12px 0; }
    .chart-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin: 6px 8px 8px;
      flex-wrap: wrap;
    }
    .chart-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .ctrl {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      font-weight: 600;
      color: #345168;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(21,37,58,0.12);
    }
    .ctrl select {
      border: 0;
      background: transparent;
      color: #26445d;
      font-size: 0.78rem;
      font-weight: 600;
      outline: none;
    }
    .btn {
      border: 1px solid rgba(17,34,51,0.16);
      background: linear-gradient(135deg, #f4511e, #ff7043);
      color: #fff;
      border-radius: 999px;
      padding: 6px 11px;
      font-size: 0.76rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.14s ease, box-shadow 0.16s ease;
      box-shadow: 0 8px 18px rgba(244,81,30,0.25);
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(244,81,30,0.28);
    }
    .btn.ghost {
      background: rgba(255,255,255,0.78);
      color: #2f4a62;
      box-shadow: none;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }
    #chart {
      width: 100%;
      height: min(72vh, 760px);
      min-height: 410px;
      border-radius: 14px;
    }
    .meta {
      margin-top: 8px;
      border-top: 1px solid var(--stroke);
      padding: 14px 16px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.32));
    }
    .tmrca-card { margin-top: 18px; }
    .chart-title {
      color: #2a425b;
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    #tmrca-track {
      width: 100%;
      height: min(46vh, 420px);
      min-height: 300px;
      border-radius: 12px;
    }
    #tmrca-state {
      width: 100%;
      height: min(34vh, 260px);
      min-height: 200px;
      border-radius: 12px;
    }
    .chart-wrap.compact {
      border-top: 1px solid rgba(17, 34, 51, 0.08);
      padding-top: 10px;
    }
    .tmrca-meta {
      margin-top: 2px;
      border-top: 1px solid rgba(17, 34, 51, 0.08);
    }
    .meta h2 {
      margin: 0 0 12px;
      font-size: 1rem;
      font-weight: 700;
      color: #23384e;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 8px 8px;
      border-bottom: 1px dashed rgba(21,37,58,0.12);
      text-align: left;
      font-size: 0.9rem;
      vertical-align: top;
    }
    th {
      width: 180px;
      color: #35506a;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.78rem;
    }
    .mono {
      font-family: "IBM Plex Mono", monospace;
      font-size: 0.78rem;
      color: #4a637d;
      word-break: break-all;
    }
    .note {
      margin-top: 10px;
      color: #5d7289;
      font-size: 0.83rem;
    }
    @media (max-width: 900px) {
      .wrap { padding: 16px 10px 22px; }
      #chart { min-height: 360px; }
      .chart-head { margin-bottom: 6px; }
      .chart-actions { gap: 6px; }
      .ctrl { font-size: 0.72rem; }
      .btn { font-size: 0.72rem; padding: 5px 10px; }
      th, td { font-size: 0.84rem; }
      th { width: 130px; font-size: 0.72rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <h1>PSMC Inference Report</h1>
      <div class="sub">Input: zigzag.psmcfa · Auto-generated from `psmc-rs` CLI · Interactive report with per-chart export.</div>
    </header>

    <section class="card control-card">
      <div class="control-grid">
        <label class="ctrl-block">Theme
          <select id="ctrl-theme">
            <option value="sunrise" selected>Sunrise</option>
            <option value="tealglass">Teal Glass</option>
            <option value="graphite">Graphite</option>
          </select>
        </label>
        <label class="ctrl-block">Line mode
          <select id="ctrl-main-mode">
            <option value="step" selected>PSMC step</option>
            <option value="linear">linear</option>
            <option value="smooth">smooth</option>
          </select>
        </label>
        <label class="ctrl-block">Main X scale
          <select id="ctrl-main-xscale">
            <option value="log" selected>log</option>
            <option value="value">linear</option>
          </select>
        </label>
        <label class="ctrl-block">Main Y scale
          <select id="ctrl-main-yscale">
            <option value="value" selected>linear</option>
            <option value="log">log</option>
          </select>
        </label>
        <label class="ctrl-block">Line width
          <input id="ctrl-main-width" type="range" min="1.2" max="5.0" step="0.2" value="3.0" />
          <span class="val" id="ctrl-main-width-val">3.0</span>
        </label>
        <label class="ctrl-block"><input id="ctrl-main-area" type="checkbox" checked /> fill area</label>
      </div>
    </section>

    <section class="card">
      <div class="chart-wrap">
        <div class="chart-head">
          <div class="chart-title">Estimated Effective Population Size</div>
          <div class="chart-actions">
            <button class="btn ghost" id="btn-main-reset" type="button">Reset</button>
            <button class="btn" id="btn-main-save" type="button">Save PNG</button>
            <button class="btn" id="btn-save-all" type="button">Save All</button>
          </div>
        </div>
        <div id="chart"></div>
      </div>
      <div class="meta">
        <h2>Run Summary</h2>
        <table>
          
<tr><th>Input</th><td class="mono">/Users/larryivanhan/Documents/lab/rspsmc/psmc-rs/experiments/core/inputs/zigzag.psmcfa</td></tr>
<tr><th>Output JSON</th><td class="mono">/Users/larryivanhan/Documents/lab/rspsmc/psmc-rs/experiments/core/outputs/zigzag.rust.bootstrap_main.json</td></tr>
<tr><th>Input format</th><td>psmcfa</td></tr>
<tr><th>EM iterations</th><td>20</td></tr>
<tr><th>n_steps</th><td>63</td></tr>
<tr><th>theta</th><td>0.055505</td></tr>
<tr><th>rho</th><td>0.017612</td></tr>
<tr><th>t_max</th><td>13.937656</td></tr>
<tr><th>mu</th><td>2.5000e-8</td></tr>
<tr><th>N0</th><td>5550.546361</td></tr>
<tr><th>bin size</th><td>100.000000</td></tr>
<tr><th>gen years</th><td>25.000000</td></tr>
<tr><th>curve points</th><td>64</td></tr>
<tr><th>x range (years)</th><td>2265.823012 - 3.8681e6</td></tr>
<tr><th>y range (Ne)</th><td>1037.957750 - 2.0432e4</td></tr>

<tr><th>Bootstrap replicates</th><td>50</td></tr>
<tr><th>Bootstrap block size</th><td>50000</td></tr>
<tr><th>Bootstrap seed</th><td>42</td></tr>

        </table>
        <div class="note">Use controls above to switch theme, axis scale, line style, and export each chart independently.</div>
      </div>
    </section>

    
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script>
    const series = [{"name":"Rust estimate","data":[[2265.8230124542324,1037.9577503454698],[4716.63516255002,1037.9577503454698],[7367.539563309562,1037.9577503454698],[10234.872394873839,2520.4788166591466],[13336.303576100428,2520.4788166591466],[16690.945655316922,3742.129295696114],[20319.47159126863,3742.129295696114],[24244.242150084636,4052.3530158321028],[28489.443703345325,4052.3530158321028],[33081.23727643094,4642.138384362891],[38047.919765660576,4642.138384362891],[43420.09831772122,6493.2607338323],[49230.87894599863,6493.2607338323],[55516.07054615731,10577.131345180624],[62314.40556821368,10577.131345180624],[69667.77870499309,16429.911903547963],[77621.50506788613,16429.911903547963],[86224.5994409111,20431.878542516497],[95530.07833398345,20431.878542516497],[105595.2866967934,19542.185415783868],[116482.25130666433,19542.185415783868],[128258.06300814143,15126.827638327999],[140995.29015985975,15126.827638327999],[154772.42583655546,10591.500165098949],[169674.37154209905,10591.500165098949],[185792.96041442893,7443.989693050949],[203227.52314663323,7443.989693050949],[222085.50011166168,5660.678687897075],[242483.1034628863,5660.678687897075],[264546.0332906968,4788.009980507804],[288410.2522484435,4788.009980507804],[314222.82342135336,4461.457891031184],[342142.81660178176,4461.457891031184],[372342.2885557139,4441.27277399693],[405007.343321402,4441.27277399693],[440339.27907422156,4579.058255291036],[478555.82862529275,4579.058255291036],[519892.50119843136,4824.612425608909],[564604.0337541214,4824.612425608909],[612965.9608042832,5182.712404283324],[665276.3123918067,5182.712404283324],[721857.450698643,5682.919406423757],[783058.0566005331,5682.919406423757],[849255.2784105074,6303.9709803466285],[920857.0560527706,6303.9709803466285],[998304.6349896806,6985.669749047304],[1082075.2853938746,6985.669749047304],[1172685.243322428,7608.0816908093875],[1270692.8920180053,7608.0816908093875],[1376702.2029417516,7958.020113530252],[1491366.4577432706,7958.020113530252],[1615392.274104301,7881.527721917274],[1749543.960265314,7881.527721917274],[1894648.2250697988,7245.468252125543],[2051599.2725518125,7245.468252125543],[2221364.312462206,7245.468252125543],[2404989.5206920546,7245.468252125543],[2603606.4863243923,6159.920385412515],[2818439.185044158,6159.920385412515],[3050811.521879935,6159.920385412515],[3302155.4897595886,6159.920385412515],[3574019.9941568333,6159.920385412515],[3868080.3982105646,6159.920385412515]]},{"name":"Bootstrap q2.5","data":[[2265.8230124542324,914.7374962182703],[4716.63516255002,914.7374962182703],[7367.539563309562,914.7374962182703],[10234.872394873839,1253.263540798335],[13336.303576100428,2138.5942643636613],[16690.945655316922,2794.2149901554144],[20319.47159126863,3512.2339730496683],[24244.242150084636,3727.872959440006],[28489.443703345325,3793.0742625499593],[33081.23727643094,4225.980744449572],[38047.919765660576,4276.863331339677],[43420.09831772122,4879.486761990133],[49230.87894599863,5799.827476838178],[55516.07054615731,6998.897608182602],[62314.40556821368,9535.023224609013],[69667.77870499309,11419.622569287689],[77621.50506788613,15393.83975694016],[86224.5994409111,19783.96138864415],[95530.07833398345,19966.47879475866],[105595.2866967934,19542.938691515752],[116482.25130666433,19542.938691515752],[128258.06300814143,15398.367366199473],[140995.29015985975,15398.367366199473],[154772.42583655546,10718.17911078844],[169674.37154209905,10718.17911078844],[185792.96041442893,7427.398850822358],[203227.52314663323,7427.398850822358],[222085.50011166168,5599.034911988167],[242483.1034628863,5599.034911988167],[264546.0332906968,4724.815855289371],[288410.2522484435,4724.815855289371],[314222.82342135336,4407.30168705143],[342142.81660178176,4407.30168705143],[372342.2885557139,4387.963165281261],[405007.343321402,4387.963165281261],[440339.27907422156,4512.240710488647],[478555.82862529275,4512.240710488647],[519892.50119843136,4748.689502831432],[564604.0337541214,4748.689502831432],[612965.9608042832,5086.968245281658],[665276.3123918067,5086.968245281658],[721857.450698643,5565.919687612111],[783058.0566005331,5565.919687612111],[849255.2784105074,6186.971333118029],[920857.0560527706,6186.971333118029],[998304.6349896806,6566.351199659188],[1082075.2853938746,6901.926784832461],[1172685.243322428,7339.823328309028],[1270692.8920180053,7581.480953090695],[1376702.2029417516,7949.095623086843],[1491366.4577432706,7949.095623086843],[1615392.274104301,7858.0281856376505],[1749543.960265314,7858.0281856376505],[1894648.2250697988,7157.839233923705],[2051599.2725518125,7157.839233923705],[2221364.312462206,7157.839233923705],[2404989.5206920546,7157.839233923705],[2603606.4863243923,5968.501531868993],[2818439.185044158,5968.501531868993],[3050811.521879935,5968.501531868993],[3302155.4897595886,5968.501531868993],[3574019.9941568333,5968.501531868993],[3868080.3982105646,5968.501531868993]]},{"name":"Bootstrap median","data":[[2265.8230124542324,1002.7397642843982],[4716.63516255002,1002.7397642843982],[7367.539563309562,1002.7397642843982],[10234.872394873839,2543.228782398648],[13336.303576100428,2557.4174188669294],[16690.945655316922,4013.3601024236677],[20319.47159126863,4017.4551122968446],[24244.242150084636,4178.983411952759],[28489.443703345325,4188.338098498062],[33081.23727643094,4549.15035066397],[38047.919765660576,4553.526427087401],[43420.09831772122,6188.470908397226],[49230.87894599863,6194.766059247575],[55516.07054615731,10199.51278036606],[62314.40556821368,10219.56866448561],[69667.77870499309,16414.152213175108],[77621.50506788613,16503.429558356125],[86224.5994409111,20994.4685929093],[95530.07833398345,21049.21422665367],[105595.2866967934,20446.857220498547],[116482.25130666433,20446.857220498547],[128258.06300814143,15817.790925334466],[140995.29015985975,15817.790925334466],[154772.42583655546,10915.991675687836],[169674.37154209905,10915.991675687836],[185792.96041442893,7558.004847572143],[203227.52314663323,7558.004847572143],[222085.50011166168,5688.963276270368],[242483.1034628863,5688.963276270368],[264546.0332906968,4787.130664305026],[288410.2522484435,4787.130664305026],[314222.82342135336,4461.915677798639],[342142.81660178176,4461.915677798639],[372342.2885557139,4446.194845770911],[405007.343321402,4446.194845770911],[440339.27907422156,4580.156301920784],[478555.82862529275,4580.156301920784],[519892.50119843136,4812.679135987927],[564604.0337541214,4812.679135987927],[612965.9608042832,5165.666838293857],[665276.3123918067,5165.666838293857],[721857.450698643,5685.293321843997],[783058.0566005331,5685.293321843997],[849255.2784105074,6341.242804644957],[920857.0560527706,6341.242804644957],[998304.6349896806,7069.987724289151],[1082075.2853938746,7088.437173587225],[1172685.243322428,7731.083745171034],[1270692.8920180053,7777.979183448782],[1376702.2029417516,8125.327675094931],[1491366.4577432706,8148.115930381411],[1615392.274104301,8086.507131463002],[1749543.960265314,8086.507131463002],[1894648.2250697988,7366.442400357508],[2051599.2725518125,7366.442400357508],[2221364.312462206,7366.442400357508],[2404989.5206920546,7366.442400357508],[2603606.4863243923,6150.743540929062],[2818439.185044158,6146.875515746677],[3050811.521879935,6146.875515746677],[3302155.4897595886,6146.875515746677],[3574019.9941568333,6146.875515746677],[3868080.3982105646,6146.875515746677]]},{"name":"Bootstrap q97.5","data":[[2265.8230124542324,1145.901622938917],[4716.63516255002,1145.901622938917],[7367.539563309562,1145.901622938917],[10234.872394873839,3058.699406048487],[13336.303576100428,3058.699406048487],[16690.945655316922,4482.74021859663],[20319.47159126863,4482.74021859663],[24244.242150084636,4517.220257743003],[28489.443703345325,4517.220257743003],[33081.23727643094,4932.424957097424],[38047.919765660576,4932.424957097424],[43420.09831772122,6698.290662741797],[49230.87894599863,6698.290662741797],[55516.07054615731,10836.088833378479],[62314.40556821368,10836.088833378479],[69667.77870499309,17689.421665715105],[77621.50506788613,17689.421665715105],[86224.5994409111,22385.49476244413],[95530.07833398345,22385.49476244413],[105595.2866967934,21367.868264311644],[116482.25130666433,21226.63414613888],[128258.06300814143,16235.659295405947],[140995.29015985975,16235.659295405947],[154772.42583655546,11188.41547625307],[169674.37154209905,11188.41547625307],[185792.96041442893,7703.060326757723],[203227.52314663323,7703.060326757723],[222085.50011166168,5765.922768949189],[242483.1034628863,5765.922768949189],[264546.0332906968,4843.165912415362],[288410.2522484435,4843.165912415362],[314222.82342135336,4528.608816145963],[342142.81660178176,4528.608816145963],[372342.2885557139,4521.032378977265],[405007.343321402,4521.032378977265],[440339.27907422156,4667.2602349765375],[478555.82862529275,4667.2602349765375],[519892.50119843136,4902.541184054909],[564604.0337541214,4902.541184054909],[612965.9608042832,5284.648104071458],[665276.3123918067,5284.648104071458],[721857.450698643,5827.8483176758855],[783058.0566005331,5827.8483176758855],[849255.2784105074,6525.716438808352],[920857.0560527706,6525.716438808352],[998304.6349896806,7299.821148727806],[1082075.2853938746,7304.636996049609],[1172685.243322428,7995.075532354321],[1270692.8920180053,8015.004762288871],[1376702.2029417516,8382.364264555643],[1491366.4577432706,8407.977974182508],[1615392.274104301,8382.640675411189],[1749543.960265314,8327.527953660827],[1894648.2250697988,8316.07960364234],[2051599.2725518125,7617.021256163447],[2221364.312462206,7617.021256163447],[2404989.5206920546,7617.021256163447],[2603606.4863243923,7617.021256163447],[2818439.185044158,6348.53917868567],[3050811.521879935,6348.53917868567],[3302155.4897595886,6348.53917868567],[3574019.9941568333,6348.53917868567],[3868080.3982105646,6348.53917868567]]}];
    const STYLE_KEY = "psmc_report_style_v2";
    const themes = {
      sunrise: {
        accent: "#f4511e",
        accent2: "#26a69a",
        mainLine: "#f4511e",
        mainArea: "rgba(244,81,30,0.10)",
        trackMean: "#1e88e5",
        trackMap: "#8e24aa",
        ci: "#64b5f6",
        stateTop: "#26a69a",
        stateBottom: "#80cbc4"
      },
      tealglass: {
        accent: "#00897b",
        accent2: "#00796b",
        mainLine: "#00897b",
        mainArea: "rgba(0,137,123,0.12)",
        trackMean: "#0277bd",
        trackMap: "#1565c0",
        ci: "#4fc3f7",
        stateTop: "#00acc1",
        stateBottom: "#80deea"
      },
      graphite: {
        accent: "#455a64",
        accent2: "#546e7a",
        mainLine: "#37474f",
        mainArea: "rgba(55,71,79,0.10)",
        trackMean: "#455a64",
        trackMap: "#263238",
        ci: "#78909c",
        stateTop: "#546e7a",
        stateBottom: "#90a4ae"
      }
    };
    const getEl = (id) => document.getElementById(id);
    const controls = {
      theme: getEl("ctrl-theme"),
      mode: getEl("ctrl-main-mode"),
      xScale: getEl("ctrl-main-xscale"),
      yScale: getEl("ctrl-main-yscale"),
      width: getEl("ctrl-main-width"),
      widthVal: getEl("ctrl-main-width-val"),
      area: getEl("ctrl-main-area")
    };

    const exportStamp = new Date().toISOString().replace(/[:.]/g, "-");
    const exportChartPng = (targetChart, name) => {
      const url = targetChart.getDataURL({
        type: "png",
        pixelRatio: 3,
        backgroundColor: "#f7fbff"
      });
      const a = document.createElement("a");
      a.href = url;
      a.download = `${name}_${exportStamp}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };
    const resetZoom = (targetChart) => {
      targetChart.dispatchAction({ type: "dataZoom", start: 0, end: 100 });
    };

    const chart = echarts.init(document.getElementById("chart"), null, { renderer: "canvas" });
    const rgba = (hex, alpha) => {
      const h = String(hex || "").trim();
      const m = /^#?([0-9a-f]{6})$/i.exec(h);
      if (!m) return `rgba(100,181,246,${alpha})`;
      const s = m[1];
      const r = parseInt(s.slice(0, 2), 16);
      const g = parseInt(s.slice(2, 4), 16);
      const b = parseInt(s.slice(4, 6), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    };

    const sanitizeScale = (v, fallback) => (v === "log" || v === "value" ? v : fallback);
    const sanitizeMode = (v) => (v === "step" || v === "linear" || v === "smooth" ? v : "step");
    const numeric = (v, fallback) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    };
    const readConfig = () => ({
      theme: controls.theme ? controls.theme.value : "sunrise",
      mode: sanitizeMode(controls.mode ? controls.mode.value : "step"),
      xScale: sanitizeScale(controls.xScale ? controls.xScale.value : "log", "log"),
      yScale: sanitizeScale(controls.yScale ? controls.yScale.value : "value", "value"),
      width: Math.min(5.0, Math.max(1.2, numeric(controls.width ? controls.width.value : 3.0, 3.0))),
      area: controls.area ? controls.area.checked : true
    });
    const saveConfig = (cfg) => {
      try {
        localStorage.setItem(STYLE_KEY, JSON.stringify(cfg));
      } catch (_) {}
    };
    const restoreConfig = () => {
      try {
        const raw = localStorage.getItem(STYLE_KEY);
        if (!raw) return;
        const cfg = JSON.parse(raw);
        if (controls.theme && cfg.theme) controls.theme.value = cfg.theme;
        if (controls.mode && cfg.mode) controls.mode.value = sanitizeMode(cfg.mode);
        if (controls.xScale && cfg.xScale) controls.xScale.value = sanitizeScale(cfg.xScale, "log");
        if (controls.yScale && cfg.yScale) controls.yScale.value = sanitizeScale(cfg.yScale, "value");
        if (controls.width && Number.isFinite(Number(cfg.width))) controls.width.value = String(cfg.width);
        if (controls.area && typeof cfg.area === "boolean") controls.area.checked = cfg.area;
      } catch (_) {}
    };

    const buildMainOption = (cfg, palette) => {
      const mode = cfg.mode;
      const stepValue = mode === "step" ? "end" : false;
      const smoothValue = mode === "smooth";
      const areaStyle = cfg.area ? { color: palette.mainArea } : undefined;
      const findSeries = (name) => {
        const key = String(name || "").toLowerCase();
        return series.find((s) => String(s.name || "").toLowerCase() === key);
      };
      const sMain = findSeries("rust estimate");
      const sQ025 = findSeries("bootstrap q2.5");
      const sQ500 = findSeries("bootstrap median");
      const sQ975 = findSeries("bootstrap q97.5");
      const mainData = sMain ? sMain.data : [];
      const q025Data = sQ025 ? sQ025.data : [];
      const q500Data = sQ500 ? sQ500.data : [];
      const q975Data = sQ975 ? sQ975.data : [];
      const hasRibbon = q025Data.length > 0 && q975Data.length > 0;

      const ribbonBase = hasRibbon ? q025Data : [];
      const ribbonDelta = hasRibbon
        ? q975Data.map((p, i) => {
            const lo = (q025Data[i] && Number.isFinite(q025Data[i][1])) ? q025Data[i][1] : p[1];
            return [p[0], Math.max(0, p[1] - lo)];
          })
        : [];
      const ciBandColor = rgba(palette.ci, 0.22);
      const legendData = ["Rust estimate"];
      if (q500Data.length > 0) legendData.push("Bootstrap median");
      if (hasRibbon) legendData.push("Bootstrap 95% CI");

      const mainSeries = [];
      if (hasRibbon) {
        mainSeries.push({
          name: "__Bootstrap CI base",
          type: "line",
          stack: "bootstrap_ci",
          step: stepValue,
          data: ribbonBase,
          showSymbol: false,
          symbol: "none",
          lineStyle: { width: 0, opacity: 0 },
          areaStyle: { opacity: 0 },
          silent: true,
          tooltip: { show: false }
        });
        mainSeries.push({
          name: "Bootstrap 95% CI",
          type: "line",
          stack: "bootstrap_ci",
          step: stepValue,
          data: ribbonDelta,
          showSymbol: false,
          symbol: "none",
          lineStyle: { width: 0, opacity: 0 },
          areaStyle: { color: ciBandColor },
          silent: true
        });
      }
      if (q500Data.length > 0) {
        mainSeries.push({
          name: "Bootstrap median",
          type: "line",
          data: q500Data,
          step: stepValue,
          smooth: false,
          showSymbol: false,
          symbol: "none",
          lineStyle: {
            width: Math.max(1.2, cfg.width - 1.0),
            color: palette.trackMap,
            type: "dashed"
          },
          itemStyle: { color: palette.trackMap }
        });
      }
      mainSeries.push({
        name: "Rust estimate",
        type: "line",
        data: mainData,
        step: stepValue,
        smooth: smoothValue,
        showSymbol: false,
        symbol: "none",
        areaStyle,
        lineStyle: { width: cfg.width, color: palette.mainLine },
        itemStyle: { color: palette.mainLine }
      });
      return {
        animationDuration: 750,
        animationEasing: "cubicOut",
        backgroundColor: "transparent",
        legend: {
          data: legendData,
          top: 14,
          left: 18,
          textStyle: { color: "#223a52", fontSize: 13, fontFamily: "Sora, sans-serif" }
        },
        grid: { left: 96, right: 58, top: 82, bottom: 98, containLabel: true },
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "cross" },
          backgroundColor: "rgba(13, 22, 34, 0.90)",
          borderWidth: 0,
          textStyle: { color: "#f2f6fb" }
        },
        toolbox: {
          right: 16,
          top: 12,
          itemSize: 15,
          feature: {
            dataZoom: { yAxisIndex: "none" },
            restore: {},
            saveAsImage: { pixelRatio: 2 }
          }
        },
        xAxis: {
          type: cfg.xScale,
          name: "Years",
          nameLocation: "middle",
          nameGap: 38,
          nameTextStyle: { color: "#334f67", fontWeight: 600 },
          axisLine: { lineStyle: { color: "#698198" } },
          axisLabel: { color: "#51697f" },
          splitLine: { lineStyle: { color: "rgba(81,105,127,0.15)" } },
          minorSplitLine: { show: cfg.xScale === "log", lineStyle: { color: "rgba(81,105,127,0.08)" } }
        },
        yAxis: {
          type: cfg.yScale,
          name: "Effective population size (Ne)",
          nameLocation: "middle",
          nameRotate: 90,
          nameGap: 74,
          nameTextStyle: { color: "#334f67", fontWeight: 600 },
          axisLine: { lineStyle: { color: "#698198" } },
          axisLabel: { color: "#51697f" },
          splitLine: { lineStyle: { color: "rgba(81,105,127,0.15)" } }
        },
        dataZoom: [
          { type: "inside", xAxisIndex: 0 },
          {
            type: "slider",
            xAxisIndex: 0,
            bottom: 18,
            height: 20,
            borderColor: "rgba(17,34,51,0.15)",
            backgroundColor: "rgba(255,255,255,0.62)",
            fillerColor: palette.mainArea,
            handleStyle: { color: palette.accent }
          }
        ],
        series: mainSeries
      };
    };

    
    const applyAllCharts = () => {
      const cfg = readConfig();
      const palette = themes[cfg.theme] || themes.sunrise;
      window.__psmcTheme = palette;
      if (controls.widthVal) controls.widthVal.textContent = cfg.width.toFixed(1);
      chart.setOption(buildMainOption(cfg, palette), true);
      if (window.__psmcTmrca && typeof window.__psmcTmrca.apply === "function") {
        window.__psmcTmrca.apply(palette);
      }
      saveConfig(cfg);
    };

    const bindChange = (id, eventName = "change") => {
      const el = getEl(id);
      if (el) el.addEventListener(eventName, applyAllCharts);
    };
    bindChange("ctrl-theme");
    bindChange("ctrl-main-mode");
    bindChange("ctrl-main-xscale");
    bindChange("ctrl-main-yscale");
    bindChange("ctrl-main-area");
    bindChange("ctrl-main-width", "input");
    bindChange("ctrl-tmrca-map");
    bindChange("ctrl-tmrca-ci");
    bindChange("ctrl-tmrca-yscale");
    bindChange("ctrl-state-metric");

    const btnMainSave = getEl("btn-main-save");
    if (btnMainSave) btnMainSave.addEventListener("click", () => exportChartPng(chart, "psmc_ne_curve"));
    const btnMainReset = getEl("btn-main-reset");
    if (btnMainReset) btnMainReset.addEventListener("click", () => resetZoom(chart));
    const btnSaveAll = getEl("btn-save-all");
    if (btnSaveAll) {
      btnSaveAll.addEventListener("click", () => {
        exportChartPng(chart, "psmc_ne_curve");
        if (window.__psmcTmrca && window.__psmcTmrca.track) {
          setTimeout(() => exportChartPng(window.__psmcTmrca.track, "psmc_tmrca_track"), 160);
        }
        if (window.__psmcTmrca && window.__psmcTmrca.state) {
          setTimeout(() => exportChartPng(window.__psmcTmrca.state, "psmc_tmrca_state"), 320);
        }
      });
    }
    const btnTmrcaSave = getEl("btn-tmrca-save");
    if (btnTmrcaSave) {
      btnTmrcaSave.addEventListener("click", () => {
        if (window.__psmcTmrca && window.__psmcTmrca.track) exportChartPng(window.__psmcTmrca.track, "psmc_tmrca_track");
      });
    }
    const btnTmrcaReset = getEl("btn-tmrca-reset");
    if (btnTmrcaReset) {
      btnTmrcaReset.addEventListener("click", () => {
        if (window.__psmcTmrca && window.__psmcTmrca.track) resetZoom(window.__psmcTmrca.track);
      });
    }
    const btnStateSave = getEl("btn-state-save");
    if (btnStateSave) {
      btnStateSave.addEventListener("click", () => {
        if (window.__psmcTmrca && window.__psmcTmrca.state) exportChartPng(window.__psmcTmrca.state, "psmc_tmrca_state");
      });
    }
    const btnStateReset = getEl("btn-state-reset");
    if (btnStateReset) {
      btnStateReset.addEventListener("click", () => {
        if (window.__psmcTmrca && window.__psmcTmrca.state) resetZoom(window.__psmcTmrca.state);
      });
    }

    restoreConfig();
    applyAllCharts();
    window.addEventListener("resize", () => {
      chart.resize();
      if (window.__psmcTmrca && window.__psmcTmrca.track) window.__psmcTmrca.track.resize();
      if (window.__psmcTmrca && window.__psmcTmrca.state) window.__psmcTmrca.state.resize();
    });
  </script>
</body>
</html>
