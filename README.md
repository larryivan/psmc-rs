# psmc-rs

`psmc-rs` is a Rust implementation of PSMC (Pairwise Sequentially Markovian Coalescent).

Current features:

- `psmcfa`, `mhs`/`multihetsep`, and `vcf` input parsing (plain text and `.gz`)
- EM-based inference with JSON parameter output
- Interactive HTML report generated by default
- Optional per-bin TMRCA posterior TSV output (mean, MAP, q2.5, q97.5)
- Optional block-bootstrap with replicate JSON outputs and summary CI tables

## Build and install

Build:

```bash
cargo build --release
```

This project provides one integrated CLI/TUI binary:

- `psmc-rs`

Then run:

```bash
psmc-rs --help
```

Install globally (optional):

```bash
cargo install --path .
```

## Quick start

### Interactive TUI

Launch:

```bash
psmc-rs --tui
```

TUI hotkeys:

- `F1` / `F2` / `F3`: switch `Setup` / `Run` / `Result` pages
- `Tab` / `Shift+Tab`: switch fields on `Setup`
- Type / `Backspace`: edit selected field
- `Ctrl+O`: open input file picker (filtered by current `Input fmt`)
- `Ctrl+D`: open output directory picker
- `Space`: toggle `Input fmt` (`psmcfa`/`mhs`/`vcf`)
- In picker: `Enter` select/open, `→` browse directory, `Backspace`/`←` go parent, `Esc`/`q` close
- `F5` (or `Enter` / `r`): start run
- `x`: request stop (safe stop at phase boundary)
- `PgUp` / `PgDn` / `End`: log scrolling
- `q`: quit (only when no job is running)

### PSMCFA input

```bash
psmc-rs \
  /path/to/input.psmcfa \
  /path/to/out.json \
  20 \
  --pattern '4+25*2+4+6' \
  --batch-size 300000
```

Outputs:

- `/path/to/out.json`
- `/path/to/out.html` (generated automatically)

### Export TMRCA posterior

```bash
psmc-rs \
  /path/to/input.psmcfa \
  /path/to/out.json \
  20 \
  --pattern '4+25*2+4+6' \
  --tmrca-out /path/to/tmrca.tsv
```

Additional output:

- `/path/to/tmrca.tsv`

### MHS input

```bash
psmc-rs \
  /path/to/input.mhs \
  /path/to/out.json \
  20 \
  --input-format mhs \
  --mhs-bin-size 100 \
  --pattern '4+25*2+4+6'
```

### VCF input

```bash
psmc-rs \
  /path/to/input.vcf.gz \
  /path/to/out.json \
  20 \
  --input-format vcf \
  --vcf-sample SAMPLE_NAME \
  --vcf-mask /path/to/callable.bed.gz \
  --vcf-negative-mask /path/to/exclude.bed.gz \
  --mhs-bin-size 100 \
  --pattern '4+25*2+4+6'
```

### Bootstrap confidence intervals

```bash
psmc-rs \
  /path/to/input.psmcfa \
  /path/to/out.json \
  20 \
  --pattern '4+25*2+4+6' \
  --bootstrap 100 \
  --bootstrap-block-size 50000
```

Additional outputs in `/path/to/out.bootstrap/` (default directory):

- `replicate_001.json` ... `replicate_100.json`
- `summary.tsv` (`x_years`, `ne_main`, `ne_q025`, `ne_q500`, `ne_q975`)
- `summary.json`

## Input formats

### `psmcfa`

- Supports text and `.gz`
- FASTA header is optional
- Parsed symbols:
  - `T` -> 0
  - `K` -> 1
  - `N` -> 2
- Other characters are ignored

### `mhs` / `multihetsep`

- Supports text and `.gz`
- Supports `.mhs`, `.multihetsep` (and `.gz`)
- Expects 4 whitespace-separated columns per row (official `generate_multihetsep.py` format):
  - `chrom`
  - `pos` (1-based genomic position)
  - `nr_called` (callable sites since the previous emitted site, inclusive)
  - `alleles` (must describe a segregating site)
- Empty lines and `#...` lines are ignored
- `nr_called` must be `> 0`
- `pos` must increase within each chromosome
- Chromosome switches start a new HMM sequence chain
- Binning is controlled by `--mhs-bin-size`
- Missingness (`N`) follows `fq2psmcfa`-style thresholding per bin (`N` if missing ratio `> 0.9`)

### `vcf`

- Supports text and `.gz` (`.vcf`, `.vcf.gz`)
- Converts diploid genotype stream to official multihetsep-like events internally:
  - `nr_called` is computed from callable sites between emitted segregating sites
  - uncalled sites are propagated to `N` via the same `fq2psmcfa` threshold logic
- If VCF has multiple samples, `--vcf-sample` is required
- Optional masks:
  - `--vcf-mask <BED>`: callable mask (repeatable)
  - `--vcf-negative-mask <BED>`: exclusion mask (repeatable)
  - mask files support 2-column (`start end`, 1-based inclusive) and BED-like (`chrom start end`, 0-based start, end-exclusive)
- Final binning still uses `--mhs-bin-size`

## Outputs

### JSON (model parameters)

Fields:

- `theta`
- `rho`
- `lam`
- `t_max`
- `n_steps`
- `mu`
- `pattern`

### HTML report (default)

For `out.json`, report path is `out.html`.

Includes:

- Main Ne curve
- Bootstrap 95% CI ribbon + median overlay when `--bootstrap > 0`
- Theme/style controls (mode, scale, line width, area fill)
- Per-chart PNG export + `Save All`
- TMRCA track/state panels when `--tmrca-out` is enabled

### TMRCA TSV (optional)

Generated when `--tmrca-out` is provided.

Columns:

- `seq_id`
- `seq_bin`
- `global_bin`
- `obs`
- `map_state`
- `tmrca_map_years`
- `tmrca_mean_years`
- `tmrca_q025_years`
- `tmrca_q975_years`
- `pmax`
- `entropy`

## CLI options

Positional arguments:

- `INPUT_FILE`
- `OUTPUT_FILE`
- `N_ITER`

Common options:

- `--tui`: launch interactive Ratatui interface
- `--threads <N>`: set Rayon thread count
- `--input-format <psmcfa|mhs|vcf>`: default `psmcfa`
- `--mhs-bin-size <INT>`: default `100` (used for `mhs` and `vcf`)
- `--vcf-sample <STR>`: sample name in VCF (required when VCF has multiple samples)
- `--vcf-mask <PATH>`: callable BED mask for VCF conversion (repeatable)
- `--vcf-negative-mask <PATH>`: exclusion BED mask for VCF conversion (repeatable)
- `--t-max <FLOAT>`: default `15`
- `--n-steps <INT>`: default `64`
- `--theta0 <FLOAT>`: optional initial theta
- `--rho0 <FLOAT>`: optional initial rho
- `--pattern <STR>`: state pattern (for example `4+25*2+4+6`)
- `--batch-size <INT>`: chunk long inputs while keeping one connected HMM chain
- `--mu <FLOAT>`: mutation rate, default `2.5e-8`
- `--mstep-iters <INT>`: max iterations for each M-step
- `--smooth-lambda <FLOAT>`: log-lambda smooth penalty, default `1e-3`
- `--bootstrap <INT>`: number of block-bootstrap replicates, default `0` (disabled)
- `--bootstrap-block-size <INT>`: bootstrap block size in bins, default `50000`
- `--bootstrap-seed <INT>`: random seed for bootstrap resampling, default `42`
- `--bootstrap-iters <INT>`: EM iterations per bootstrap replicate (default: `N_ITER`)
- `--bootstrap-dir <PATH>`: output directory for bootstrap replicate and summary files
- `--no-progress`: disable progress bars
- `--tmrca-out <PATH>`: write TMRCA posterior TSV and add TMRCA panels to HTML
- `--tmrca-gen-years <FLOAT>`: generation time for TMRCA scaling, default `25`

## Pattern format

- `a*b`: one free parameter repeated `b` time states, repeated for `a` groups
- `L`: shorthand for `1*L`

Example:

- `4+25*2+4+6`

Notes:

- Consistency between `pattern` and `n_steps` is validated
- A legacy state-count compatibility shim is supported

## Performance tips

- Always use release build
- Use `--batch-size` for long inputs to control memory
- Use `--threads` on multi-core machines
- Use `--no-progress` for batch runs
- E-step alpha cache budget can be tuned with `PSMC_ALPHA_CACHE_MB` (default `2048` MB)
- When budget is insufficient, `psmc-rs` now caches a subset of rows instead of disabling cache entirely
- Example: `PSMC_ALPHA_CACHE_MB=2048 psmc-rs ...`
- E-step now uses a lower-level hot loop kernel by default for better single-thread speed
- For bootstrap, reduce `--bootstrap-iters` first if runtime is high

## Experiment workspace

- Reproducible manuscript experiments are organized under `experiment/`
- See `experiment/README.md` for directory layout, notebooks, scripts, and output conventions
- Main-text one-click notebook: `experiment/notebooks/main_text_6items.ipynb`
- Supplementary one-click notebook: `experiment/notebooks/supplementary_S1_S5.ipynb`

## License

MIT. See `LICENSE`.
