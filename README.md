# psmc-rs

`psmc-rs` is a Rust implementation of PSMC (Pairwise Sequentially Markovian Coalescent).

Current features:

- `psmcfa` and `mhs` input parsing (plain text and `.gz`)
- EM-based inference with JSON parameter output
- Interactive HTML report generated by default
- Optional per-bin TMRCA posterior TSV output (mean, MAP, q2.5, q97.5)
- Optional block-bootstrap with replicate JSON outputs and summary CI tables

## Build and install a `psmc-rs` command

Build:

```bash
cargo build --release
```

Create a local command named `psmc-rs`:

```bash
mkdir -p "$HOME/.local/bin"
ln -sf "$(pwd)/target/release/psmc" "$HOME/.local/bin/psmc-rs"
```

Make sure `$HOME/.local/bin` is in your `PATH`:

```bash
export PATH="$HOME/.local/bin:$PATH"
```

Then run:

```bash
psmc-rs --help
```

## Quick start

### PSMCFA input

```bash
psmc-rs \
  /path/to/input.psmcfa \
  /path/to/out.json \
  20 \
  --pattern '4+25*2+4+6' \
  --batch-size 300000
```

Outputs:

- `/path/to/out.json`
- `/path/to/out.html` (generated automatically)

### Export TMRCA posterior

```bash
psmc-rs \
  /path/to/input.psmcfa \
  /path/to/out.json \
  20 \
  --pattern '4+25*2+4+6' \
  --tmrca-out /path/to/tmrca.tsv
```

Additional output:

- `/path/to/tmrca.tsv`

### MHS input

```bash
psmc-rs \
  /path/to/input.mhs \
  /path/to/out.json \
  20 \
  --input-format mhs \
  --mhs-bin-size 100 \
  --pattern '4+25*2+4+6'
```

### Bootstrap confidence intervals

```bash
psmc-rs \
  /path/to/input.psmcfa \
  /path/to/out.json \
  20 \
  --pattern '4+25*2+4+6' \
  --bootstrap 100 \
  --bootstrap-block-size 50000
```

Additional outputs in `/path/to/out.bootstrap/` (default directory):

- `replicate_001.json` ... `replicate_100.json`
- `summary.tsv` (`x_years`, `ne_main`, `ne_q025`, `ne_q500`, `ne_q975`)
- `summary.json`

## Input formats

### `psmcfa`

- Supports text and `.gz`
- FASTA header is optional
- Parsed symbols:
  - `T` -> 0
  - `K` -> 1
  - `N` -> 2
- Other characters are ignored

### `mhs`

- Supports text and `.gz`
- Expects at least 3 whitespace-separated columns per row:
  - `chrom`
  - `pos`
  - `nr_called`
- Empty lines and `#...` lines are ignored
- Only the first 3 columns are used
- `nr_called` must be `> 0`
- Binning is controlled by `--mhs-bin-size`

## Outputs

### JSON (model parameters)

Fields:

- `theta`
- `rho`
- `lam`
- `t_max`
- `n_steps`
- `mu`
- `pattern`

### HTML report (default)

For `out.json`, report path is `out.html`.

Includes:

- Main Ne curve
- Bootstrap 95% CI ribbon + median overlay when `--bootstrap > 0`
- Theme/style controls (mode, scale, line width, area fill)
- Per-chart PNG export + `Save All`
- TMRCA track/state panels when `--tmrca-out` is enabled

### TMRCA TSV (optional)

Generated when `--tmrca-out` is provided.

Columns:

- `seq_id`
- `seq_bin`
- `global_bin`
- `obs`
- `map_state`
- `tmrca_map_years`
- `tmrca_mean_years`
- `tmrca_q025_years`
- `tmrca_q975_years`
- `pmax`
- `entropy`

## CLI options

Positional arguments:

- `INPUT_FILE`
- `OUTPUT_FILE`
- `N_ITER`

Common options:

- `--threads <N>`: set Rayon thread count
- `--input-format <psmcfa|mhs>`: default `psmcfa`
- `--mhs-bin-size <INT>`: default `100`
- `--t-max <FLOAT>`: default `15`
- `--n-steps <INT>`: default `64`
- `--theta0 <FLOAT>`: optional initial theta
- `--rho0 <FLOAT>`: optional initial rho
- `--pattern <STR>`: state pattern (for example `4+25*2+4+6`)
- `--batch-size <INT>`: chunk long inputs while keeping one connected HMM chain
- `--mu <FLOAT>`: mutation rate, default `2.5e-8`
- `--mstep-iters <INT>`: max iterations for each M-step
- `--smooth-lambda <FLOAT>`: log-lambda smooth penalty, default `1e-3`
- `--bootstrap <INT>`: number of block-bootstrap replicates, default `0` (disabled)
- `--bootstrap-block-size <INT>`: bootstrap block size in bins, default `50000`
- `--bootstrap-seed <INT>`: random seed for bootstrap resampling, default `42`
- `--bootstrap-iters <INT>`: EM iterations per bootstrap replicate (default: `N_ITER`)
- `--bootstrap-dir <PATH>`: output directory for bootstrap replicate and summary files
- `--no-progress`: disable progress bars
- `--tmrca-out <PATH>`: write TMRCA posterior TSV and add TMRCA panels to HTML
- `--tmrca-gen-years <FLOAT>`: generation time for TMRCA scaling, default `25`

## Pattern format

- `a*b`: one free parameter repeated `b` time states, repeated for `a` groups
- `L`: shorthand for `1*L`

Example:

- `4+25*2+4+6`

Notes:

- Consistency between `pattern` and `n_steps` is validated
- A legacy state-count compatibility shim is supported

## Performance tips

- Always use release build
- Use `--batch-size` for long inputs to control memory
- Use `--threads` on multi-core machines
- Use `--no-progress` for batch runs
- For bootstrap, reduce `--bootstrap-iters` first if runtime is high

## License

MIT. See `LICENSE`.
